{% extends "base.html" %}

{% block title %}Dashboard de Analítica{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Dashboard de Analítica de Crímenes</h1>
    <p class="subtitle">Métricas Clave del Modelo (Violento vs. No Violento)</p>
</div>

{% if metrics %}
    <div class="metrics-grid">
        <div class="card metric-card">
            <h3>Precisión General (Accuracy)</h3>
            <div class="value">{{ "%.2f"|format(metrics.accuracy * 100) }}%</div>
        </div>
        {% if metrics.auc_roc %}
        <div class="card metric-card">
            <h3>AUC-ROC</h3>
            <div class="value">{{ "%.4f"|format(metrics.auc_roc) }}</div>
            <small>Capacidad de distinguir clases</small>
        </div>
        {% endif %}
        {% if metrics['Violento'] and metrics['Violento']['f1-score'] %}
        <div class="card metric-card">
            <h3>F1-Score ('Violento')</h3>
            <div class="value">{{ "%.4f"|format(metrics['Violento']['f1-score']) }}</div>
            <small>Balance Precisión/Recall (Violento)</small>
        </div>
        {% endif %}
        <div class="card metric-card">
            <h3>F1-Score Ponderado</h3>
            <div class="value">{{ "%.4f"|format(metrics['weighted avg']['f1-score']) }}</div>
            <small>Balance general Precisión/Recall</small>
        </div>
    </div>

    {% if location_analysis %}
    <div class="card full-width-card">
        <h2>Análisis de Lugares (Frecuencia de Incidentes)</h2>
        <div class="location-lists">
            <div>
                <h3>Top 5 Lugares Más Comunes</h3>
                <ul>
                    {% for loc, count in location_analysis.most_dangerous.items() %}
                        <li>{{ loc }} ({{ count }})</li>
                    {% endfor %}
                </ul>
            </div>
            {% if location_analysis.least_dangerous %}
            <div>
                <h3>Top 5 Lugares Menos Comunes</h3>
                <ul>
                     {% for loc, count in location_analysis.least_dangerous.items() %}
                        <li>{{ loc }} ({{ count }})</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="plots-grid">
        {% if plot_paths and plot_paths.confusion_matrix %}
        <div class="card plot-card">
            <h2>Matriz de Confusión</h2>
            <img src="{{ url_for('static', filename=plot_paths.confusion_matrix) }}" alt="Matriz de Confusión">
        </div>
        {% endif %}
        {% if plot_paths and plot_paths.feature_importance %}
        <div class="card plot-card">
            <h2>Importancia de Características</h2>
            <img src="{{ url_for('static', filename=plot_paths.feature_importance) }}" alt="Importancia de Características">
        </div>
        {% endif %}
        <div class="card plot-card">
            <h2>Top 10 Crímenes Originales</h2>
            <img src="{{ url_for('static', filename='img/crime_distribution.png') }}" alt="Distribución de Crímenes">
        </div>
        <div class="card plot-card">
            <h2>Incidentes por Día de la Semana</h2>
            <img src="{{ url_for('static', filename='img/crimes_by_day.png') }}" alt="Crímenes por Día">
        </div>
    </div>

{% else %}
    <div class="card error-card">
        <p> No se pudieron cargar las métricas. Por favor, asegúrate de que el pipeline (`python -m src.pipeline`) se haya ejecutado correctamente y que el archivo `reports/dashboard_metrics.json` exista.</p>
    </div>
{% endif %}

{% endblock %}